# Connection Tracker / Firewall Rules Indicator

## Problems

1. Monitor host application's connections;
2. Understand the traffic from host (or firewall);
3. Create iptables (or nf_tables) rules;
4. Blame a firewall rule for a behavior (accept/deny);
5. Optimize your firewall rules;

## Solutions

1. You can tcpdump/wireshark your firewall and be crazy.
2. You can match a flow and target to LOG plugin, observing tons of log entries.
3. You can use NFLOG target plugin together with ulogd2 daemon.

or you can use **conntracker**.

## Doing things by hand

Let's say you don't have conntracker. To have something similar to what it provides, you would have to:

1. Make conntracker do the dirty job: map/unmap existing networking flows. 

```
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [3:156]
:POSTROUTING ACCEPT [3:156]
-A PREROUTING -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A INPUT -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A POSTROUTING -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Thu Jan 14 01:35:24 2021
# Generated by iptables-save v1.8.5 on Thu Jan 14 01:35:24 2021
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [3:156]
-A INPUT -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Thu Jan 14 01:35:24 2021
# Generated by iptables-save v1.8.5 on Thu Jan 14 01:35:24 2021
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A PREROUTING -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A INPUT -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
-A POSTROUTING -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Thu Jan 14 01:35:24 2021
# Generated by iptables-save v1.8.5 on Thu Jan 14 01:35:24 2021
*raw
:PREROUTING ACCEPT [2:164]
:OUTPUT ACCEPT [3:192]
-A PREROUTING -s 192.168.100.203/32 -d 192.168.100.13/32 -p tcp -m tcp --dport 8009 -j TRACE
-A OUTPUT -s 192.168.100.203/32 -d 192.168.100.13/32 -p tcp -m tcp --dport 8009 -j TRACE
COMMIT
```

and to analyze the outcome:

```
$ sudo conntrack -E -e NEW

    [NEW] udp      17 30 src=192.168.100.251 dst=8.8.8.8 sport=53798 dport=53 [UNREPLIED] src=8.8.8.8 dst=192.168.200.2 sport=53 dport=53798
    [NEW] tcp      6 120 SYN_SENT src=192.168.100.118 dst=34.71.14.52 sport=40414 dport=443 [UNREPLIED] src=34.71.14.52 dst=192.168.200.2 sport=443 dport=40414
    [NEW] udp      17 30 src=192.168.100.251 dst=8.8.8.8 sport=33914 dport=53 [UNREPLIED] src=8.8.8.8 dst=192.168.200.2 sport=53 dport=33914
    [NEW] udp      17 30 src=192.168.100.251 dst=8.8.8.8 sport=41433 dport=53 [UNREPLIED] src=8.8.8.8 dst=192.168.200.2 sport=53 dport=41433
    [NEW] tcp      6 120 SYN_SENT src=192.168.100.118 dst=130.44.215.56 sport=40752 dport=80 [UNREPLIED] src=130.44.215.56 dst=192.168.200.2 sport=80 dport=40752
```

sorting all the output by protocol, source/destination addresses and source/destination port numbers. This would tell you what firewall rules would have to exist in your firewall to allow the flows (or block them).

But this is just half of the problem. If you want to understand why a specific flow is being blocked, you would have to trace that flow and check through which firewall rules that flow is flowing.

To trace all networking flows, you could:

```
sudo iptables -t raw -A PREROUTING -j TRACE
sudo iptables -t raw -A OUTPUT-j TRACE
sudo ip6tables -t raw -A PREROUTING -j TRACE
sudo ip6tables -t raw -A OUTPUT-j TRACE
```

and observe kmsg:

```
[ 1934.356558] TRACE: raw:OUTPUT:policy:2 IN= OUT=home SRC=192.168.100.203 DST=192.168.100.153 LEN=52 TOS=0x10 PREC=0x00 TTL=64 ID=26607 DF PROTO=TCP SPT=35310 DPT=22 SEQ=3621638314 ACK=4253970834 WINDOW=10016 RES=0x00 ACK URGP=0 OPT (0101080A938A85A902782273) UID=1000 GID=1000 
[ 1934.867689] TRACE: filter:OUTPUT:policy:1 IN= OUT=home SRC=192.168.100.203 DST=192.168.100.153 LEN=52 TOS=0x10 PREC=0x00 TTL=64 ID=26608 DF PROTO=TCP SPT=35310 DPT=22 SEQ=3621638314 ACK=4253970990 WINDOW=10016 RES=0x00 ACK URGP=0 OPT (0101080A938A87A802782470) UID=1000 GID=1000 
[ 1935.393687] TRACE: raw:OUTPUT:policy:2 IN= OUT=home SRC=192.168.100.203 DST=192.168.100.153 LEN=52 TOS=0x10 PREC=0x00 TTL=64 ID=26610 DF PROTO=TCP SPT=35310 DPT=22 SEQ=3621638406 ACK=4253971082 WINDOW=10016 RES=0x00 ACK URGP=0 OPT (0101080A938A89B60278267A) UID=1000 GID=1000 
[ 1935.687541] TRACE: filter:OUTPUT:policy:1 IN= OUT=home SRC=192.168.100.203 DST=192.168.100.153 LEN=52 TOS=0x10 PREC=0x00 TTL=64 ID=26611 DF PROTO=TCP SPT=35310 DPT=22 SEQ=3621638406 ACK=4253971238 WINDOW=10016 RES=0x00 ACK URGP=0 OPT (0101080A938A8ADC0278279B) UID=1000 GID=1000 
```

but then you would add too much work to your netfilter code, making kernel to inform about all flows being tracked by conntracker, for example. Correct thing to do would be to trace each flow for a specific amount of time, once its first seen, and then stop it. 

The **conntracker** tool does all that automatically.

## Compiling

In order to compile it you will need the following Ubuntu packages installed:

 * pkg-config
 * libglib2.0-dev
 * libmnl-dev
 * libnetfilter-conntrack-dev

In order to run it in another host you will need at least packages:

 * libglib2.0-0
 * libmnl0
 * libnetfilter-conntrack3

installed.

```
$ ./configure --prefix=/usr --enable-debug
generating makefile ...
configuration complete, type make to build.

$ make
cc -MMD -Wall -O2 -g -ggdb -DEBUG `pkg-config --cflags glib-2.0`   -c -o conntracker.o conntracker.c
cc -MMD -Wall -O2 -g -ggdb -DEBUG `pkg-config --cflags glib-2.0`   -c -o flows.o flows.c
cc -MMD -Wall -O2 -g -ggdb -DEBUG `pkg-config --cflags glib-2.0`   -c -o footprint.o footprint.c
cc -MMD -Wall -O2 -g -ggdb -DEBUG `pkg-config --cflags glib-2.0`   -c -o general.o general.c
cc -MMD -Wall -O2 -g -ggdb -DEBUG `pkg-config --cflags glib-2.0`   -c -o iptables.o iptables.c
cc -MMD -Wall -O2 -g -ggdb -DEBUG `pkg-config --cflags glib-2.0`   -c -o nlmsg.o nlmsg.c
cc -o conntracker conntracker.o flows.o footprint.o general.o iptables.o nlmsg.o `pkg-config --libs glib-2.0` `pkg-config --libs libmnl` `pkg-config --libs libnetfilter_conntrack`
```

## Installing

Makefile will install compiled binary in $prefix/bin directory:

```
$ sudo make install
mkdir -p /usr/bin
cp conntracker /usr/bin/conntracker
```

and uninstall it as well:

```
$ sudo make uninstall
rm -f /usr/bin/conntracker
```

## Installing Packages

This will install the "conntracker" PPA with stable packages:

```
$ sudo add-apt-repository ppa:conntracker/stable
Note: PPA publishes dbgsym
  You need to add 'main/debug' component to install the ddebs,
  but apt update will print warning if the PPA has no ddebs
Repository: 'deb http://ppa.launchpad.net/conntracker/stable/ubuntu/ groovy main'
More info: https://launchpad.net/~conntracker/+archive/ubuntu/stable
Adding repository.
Press [ENTER] to continue or Ctrl-c to cancel.
```

After installing the PPA you can install the conntracker package:

```
$ sudo apt-get update
$ sudo apt-get install conntracker
$ sudo conntracker
```

And you will get automatic updates every time there is one.

## Installing Manually

If you don't want to add the PPA through "add-apt-repository", you may add the repository key manually, update your sources.list file:

```
$ sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys AE4B4EA33C3DAE9E441E256C6B25BC6DF8365E53
$ echo "deb http://ppa.launchpad.net/conntracker/stable/ubuntu/ `lsb_release -cs` main" | sudo tee -a /etc/apt/sources.list
```

And install the binary package:

```
$ sudo apt-get update
$ sudo apt-get install conntracker
$ sudo conntracker
```

## Using

Easily follow 2 steps:

1. Execute conntracker [options]:

```
       [-d]   Start as a daemon:
               - syslog msgs
               - output file
               - kill using pidfile

       [-f]   Start in foreground (default):
               - stdout msgs
               - output file
               - kill using ctrl+c

       [-o filename | - ]

               File containing flows and traces in the following format:

               PROTO [ flow # ] src = X (port=Y) to dst = W (port=Z) (F)
                   ...
                   table: A, chain: B, type: C, position: D
                   ...
                   ... [all events traced during execution for this flow]
                   ...
               ...
               ... [all flows observed during execution]
               ...

               X = Source Address
               Y = Source Port Number (>=1024 is always 1024)
               W = Destination Address
               Z = Destination Port Number
               F = "confirmed" if flow in both directions

       [-c]   Disable rules tracing feature.

              Use  this option if all you are interested is the existing flows
              in the host (and not through which netfilter rules the flows are
              passing through).
```

2. Read generated file (or output).

The output of “conntracker” tool is self explanatory BUT some observations should be made:

  1. The output is **sorted** by **PROTOCOL** first, then by **SOURCE ADDRESS**, then by
     **DESTINATION ADDRESS** and finally by **SOURCE** and **DESTINATION PORTS**. This is
     on purpose so the person executing it is able to observe IPs of a same
     subnet mask close enough to decide if future iptables rules should be HOST
     or SUBNET oriented. (Example: I have observed 192.168.100.100 to
     192.168.100.254 hosts communicating to a destiny port 80... I can then
     decide to allow 192.168.100.0/24 subnet instead of having one rule per
     IP).

  2. In between the lines indicating each flow, you may find lines similar to:<BR><BR>
     `table: xxxx, chain: xxxx, type: xxxx, position: xxxx`<BR><BR>
     Possible values for "table" are: `raw, mangle, nat or filter`<BR>
     Possible values for "chain" are: `PREROUTING, POSTROUTING, FORWARD, INPUT, OUTPUT or custom`<BR>
     Possible values for "type" are: `policy, rule or return`<BR>
     <BR>
     those lines indicate that **conntracker** was able to trace netfilter rules and tables THAT flow passed through. Next thing to do is to observe the picture bellow so you know the path the flow had inside your netfilter:
     
  ![](docs/netfilter.png)

  3. Several (port=1024) can be observed. That happens because **ANY SOURCE PORT
     bigger than 1024 is set as “1024”**. This makes observability much easier as
     the source ports tend to be random enough to cause confusion when
     observing flows. So, if you see (port=1024) in a flow, it likely means
     that an unprivileged source port was used by the source IP to communicate
     with a destiny port of a remote host.

  3. At the end of each flow you can find the “**(confirmed)**” statement
     sometimes. This has different meanings depending on the protocol being
     reported:
   * **TCP**: “(confirmed)” means that there was a bidirectional communication in
    that flow or, in other words, both hosts send and received packets in a
    connection. The TCP case is easy because it is a connection oriented
    protocol and its easy to know if there is an ongoing connection (with ACKs
    being sent).
   * **UDP**: “(confirmed)” means that there was a bi-direction communication in that
    flow. It means that one peer sent an UDP packet from a source port to
    another peer in a destination port. The other peer responded from this same
    destination port to the source port of the first one. Note: differently
    than TCP, when we can know for sure the connection was NOT blocked, In UDP
    we cannot say that for sure since some hosts might only send UDP packets
    and they might be received by the other peer that does not need to respond
    (as there are no ACKs). With that... even the flows not stating
    “(confirmed)” should be taking in consideration when designing the firewall
    rules.
   * **ICMP**: Very similar to the UDP case but, as there are no ports in ICMP
    communication, the flows are tracked by their types and codes. Some types
    are replies to another, some replies have the same type but different
    codes, and so on. Example: If you see an ICMP flow of type 0 (ECHO REPLY)
    being logged and with a “(confirmed)” statement at the end... it means that
    there was an ICMP ECHO REQUEST tracked already coming from the opposite
    direction (thus the confirmed state).

## Example

```
$ sudo ./conntracker 
Starting to capture conntrack events
Foreground mode...<Ctrl-C> or or SIG_TERM to end it.
Dumping internal data into: /tmp/conntracker.log
Finished capturing conntrack/ulog events
```

To check what was observed during the execution of the tool, and through which netfilter tables and rules that flow passed through, you just have to check generated file:

```
 TCPv4 [           0] src = 127.0.0.1 (port=1024) to dst = 127.0.0.1 (port=3128) (confirmed)
 TCPv4 [           1] src = 127.0.0.1 (port=1024) to dst = 127.0.0.1 (port=33988) (confirmed)
                                table: raw, chain: PREROUTING, type: policy, position: 8
                                table: raw, chain: PREROUTING, type: policy, position: 9
                                table: raw, chain: PREROUTING, type: policy, position: 14
                                table: raw, chain: PREROUTING, type: policy, position: 17
                                table: raw, chain: PREROUTING, type: policy, position: 23
                                table: raw, chain: PREROUTING, type: policy, position: 27
                                table: raw, chain: PREROUTING, type: policy, position: 28
                                table: raw, chain: PREROUTING, type: policy, position: 29
                                table: raw, chain: PREROUTING, type: policy, position: 30
                                table: raw, chain: PREROUTING, type: policy, position: 32
                                table: raw, chain: PREROUTING, type: rule, position: 3
                                table: raw, chain: PREROUTING, type: rule, position: 5
                                table: raw, chain: PREROUTING, type: rule, position: 6
                                table: raw, chain: PREROUTING, type: rule, position: 22
                                table: raw, chain: PREROUTING, type: rule, position: 26
                                table: raw, chain: PREROUTING, type: rule, position: 27
                                table: raw, chain: PREROUTING, type: rule, position: 28
                                table: mangle, chain: INPUT, type: rule, position: 1
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: mangle, chain: PREROUTING, type: rule, position: 1
                                table: filter, chain: INPUT, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [           2] src = 10.250.97.1 (port=1024) to dst = 10.250.97.135 (port=22) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [           3] src = 149.154.175.53 (port=443) to dst = 192.168.100.203 (port=49924)
 TCPv4 [           4] src = 104.20.62.113 (port=443) to dst = 192.168.100.203 (port=55042) (confirmed)
                                table: mangle, chain: INPUT, type: rule, position: 1
                                table: mangle, chain: PREROUTING, type: rule, position: 1
                                table: filter, chain: INPUT, type: rule, position: 1
 TCPv4 [           5] src = 10.250.97.135 (port=22) to dst = 10.250.97.1 (port=40750) (confirmed)
                                table: mangle, chain: INPUT, type: rule, position: 1
                                table: mangle, chain: PREROUTING, type: rule, position: 1
                                table: filter, chain: INPUT, type: rule, position: 1
 TCPv4 [           6] src = 10.250.97.139 (port=835) to dst = 10.250.97.1 (port=2049) (confirmed)
 TCPv4 [           7] src = 192.168.100.203 (port=1024) to dst = 140.82.113.3 (port=22) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [           8] src = 192.168.100.203 (port=1024) to dst = 140.82.113.3 (port=443) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [           9] src = 192.168.100.203 (port=1024) to dst = 13.227.120.3 (port=443) (confirmed)
 TCPv4 [          10] src = 192.168.100.203 (port=1024) to dst = 140.82.114.5 (port=443) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          11] src = 192.168.100.203 (port=1024) to dst = 140.82.113.26 (port=443) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          12] src = 192.168.100.203 (port=1024) to dst = 18.205.40.43 (port=443) (confirmed)
 TCPv4 [          13] src = 192.168.100.203 (port=1024) to dst = 104.19.217.45 (port=443) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          14] src = 192.168.100.203 (port=1024) to dst = 104.19.218.45 (port=443) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          15] src = 192.168.100.203 (port=1024) to dst = 149.154.175.51 (port=80) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          16] src = 192.168.100.203 (port=1024) to dst = 149.154.175.51 (port=443) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          17] src = 192.168.100.203 (port=1024) to dst = 149.154.175.53 (port=80) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          18] src = 192.168.100.203 (port=1024) to dst = 149.154.175.53 (port=443) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          19] src = 192.168.100.203 (port=1024) to dst = 13.227.108.76 (port=443) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          20] src = 192.168.100.203 (port=1024) to dst = 66.111.4.88 (port=443) (confirmed)
 TCPv4 [          21] src = 192.168.100.203 (port=1024) to dst = 151.101.194.109 (port=443) (confirmed)
 TCPv4 [          22] src = 192.168.100.203 (port=1024) to dst = 104.20.63.113 (port=443) (confirmed)
 TCPv4 [          23] src = 192.168.100.203 (port=1024) to dst = 162.213.33.129 (port=443) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          24] src = 192.168.100.203 (port=1024) to dst = 151.101.0.133 (port=443) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          25] src = 192.168.100.203 (port=1024) to dst = 151.101.192.133 (port=443) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          26] src = 192.168.100.203 (port=1024) to dst = 66.111.4.147 (port=443) (confirmed)
 TCPv4 [          27] src = 192.168.100.203 (port=1024) to dst = 192.168.100.153 (port=22) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 TCPv4 [          28] src = 192.168.100.203 (port=1024) to dst = 185.199.108.154 (port=443) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 UDPv4 [           0] src = 0.0.0.0 (port=68) to dst = 255.255.255.255 (port=67)
 UDPv4 [           1] src = 127.0.0.1 (port=1024) to dst = 127.0.0.1 (port=53) (confirmed)
 UDPv4 [           2] src = 10.250.91.1 (port=1024) to dst = 239.255.255.250 (port=1900)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 UDPv4 [           3] src = 10.250.92.1 (port=1024) to dst = 239.255.255.250 (port=1900)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 UDPv4 [           4] src = 10.250.93.1 (port=1024) to dst = 239.255.255.250 (port=1900)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 UDPv4 [           5] src = 10.250.94.1 (port=1024) to dst = 239.255.255.250 (port=1900)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 UDPv4 [           6] src = 10.250.95.1 (port=1024) to dst = 239.255.255.250 (port=1900)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 UDPv4 [           7] src = 10.250.96.1 (port=1024) to dst = 239.255.255.250 (port=1900)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 UDPv4 [           8] src = 10.250.97.1 (port=1024) to dst = 239.255.255.250 (port=1900)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 UDPv4 [           9] src = 192.168.150.3 (port=1024) to dst = 239.255.255.250 (port=1900)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 UDPv4 [          10] src = 192.168.200.3 (port=1024) to dst = 239.255.255.250 (port=1900)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 UDPv4 [          11] src = 192.168.100.13 (port=1024) to dst = 224.0.0.251 (port=5353)
                                table: mangle, chain: INPUT, type: rule, position: 1
                                table: mangle, chain: PREROUTING, type: rule, position: 1
                                table: filter, chain: INPUT, type: rule, position: 1
 UDPv4 [          12] src = 10.250.97.106 (port=1024) to dst = 192.168.100.251 (port=53)
                                table: mangle, chain: FORWARD, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: mangle, chain: PREROUTING, type: rule, position: 1
                                table: nat, chain: POSTROUTING, type: rule, position: 1
                                table: nat, chain: PREROUTING, type: rule, position: 1
                                table: filter, chain: FORWARD, type: rule, position: 1
 UDPv4 [          13] src = 10.250.97.118 (port=1024) to dst = 192.168.100.251 (port=53)
                                table: mangle, chain: FORWARD, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: mangle, chain: PREROUTING, type: rule, position: 1
                                table: nat, chain: POSTROUTING, type: rule, position: 1
                                table: nat, chain: PREROUTING, type: rule, position: 1
                                table: filter, chain: FORWARD, type: rule, position: 1
 UDPv4 [          14] src = 10.250.97.120 (port=1024) to dst = 192.168.100.251 (port=53)
                                table: mangle, chain: FORWARD, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: mangle, chain: PREROUTING, type: rule, position: 1
                                table: nat, chain: POSTROUTING, type: rule, position: 1
                                table: nat, chain: PREROUTING, type: rule, position: 1
                                table: filter, chain: FORWARD, type: rule, position: 1
 UDPv4 [          15] src = 192.168.100.123 (port=1024) to dst = 224.0.0.251 (port=5353)
                                table: mangle, chain: INPUT, type: rule, position: 1
                                table: mangle, chain: PREROUTING, type: rule, position: 1
                                table: filter, chain: INPUT, type: rule, position: 1
 UDPv4 [          16] src = 10.250.97.135 (port=1024) to dst = 192.168.100.251 (port=53)
                                table: mangle, chain: FORWARD, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: mangle, chain: PREROUTING, type: rule, position: 1
                                table: nat, chain: POSTROUTING, type: rule, position: 1
                                table: nat, chain: PREROUTING, type: rule, position: 1
                                table: filter, chain: FORWARD, type: rule, position: 1
 UDPv4 [          17] src = 192.168.100.203 (port=1024) to dst = 239.255.255.250 (port=1900)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
 UDPv4 [          18] src = 192.168.100.203 (port=1024) to dst = 192.168.100.251 (port=53) (confirmed)
 UDPv4 [          19] src = 192.168.100.203 (port=138) to dst = 192.168.100.255 (port=138)
 UDPv4 [          20] src = 192.168.100.251 (port=1024) to dst = 192.168.100.203 (port=45564)
                                table: mangle, chain: INPUT, type: rule, position: 1
                                table: mangle, chain: PREROUTING, type: rule, position: 1
                                table: filter, chain: INPUT, type: rule, position: 1
 TCPv6 [           0] src = fe80::472:eeff:fef8:dbb6 (port=1024) to dst = fe80::216:3eff:fe7f:aedd (port=22) (confirmed)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
ICMPv6 [           0] src = fe80::472:eeff:fef8:dbb6 to dst = fe80::216:3eff:fe7f:aedd (type=0 | code=0) (confirmed)
 UDPv6 [           0] src = fe80::472:eeff:fef8:dbb6 (port=1024) to dst = fe80::216:3eff:fe7f:aedd (port=8080)
                                table: mangle, chain: OUTPUT, type: rule, position: 1
                                table: mangle, chain: POSTROUTING, type: rule, position: 1
                                table: nat, chain: OUTPUT, type: rule, position: 1
                                table: nat, chain: POSTROUTING, type: rule, position: 1
                                table: filter, chain: OUTPUT, type: rule, position: 1
```

If I want to only see IPv4 flows, with no trace output, for example, you might work with grep:

```
$ cat /tmp/conntracker.log | egrep -E "^\s+TCPv4"
 TCPv4 [           0] src = 127.0.0.1 (port=1024) to dst = 127.0.0.1 (port=3128) (confirmed)
 TCPv4 [           1] src = 10.250.97.1 (port=1024) to dst = 10.250.97.135 (port=22) (confirmed)
 TCPv4 [           2] src = 10.250.97.1 (port=1024) to dst = 10.250.97.135 (port=36576) (confirmed)
 TCPv4 [           3] src = 10.250.97.1 (port=1024) to dst = 10.250.97.135 (port=36580) (confirmed)
 TCPv4 [           4] src = 192.168.100.203 (port=1024) to dst = 35.186.224.12 (port=443) (confirmed)
 TCPv4 [           5] src = 192.168.100.203 (port=1024) to dst = 192.168.100.13 (port=8009) (confirmed)
 TCPv4 [           6] src = 192.168.100.203 (port=1024) to dst = 35.186.224.25 (port=443) (confirmed)
 TCPv4 [           7] src = 192.168.100.203 (port=1024) to dst = 104.19.216.45 (port=443) (confirmed)
 TCPv4 [           8] src = 192.168.100.203 (port=1024) to dst = 149.154.175.51 (port=443) (confirmed)
 TCPv4 [           9] src = 192.168.100.203 (port=1024) to dst = 172.217.162.106 (port=443) (confirmed)
 TCPv4 [          10] src = 192.168.100.203 (port=1024) to dst = 172.217.192.109 (port=993) (confirmed)
 TCPv4 [          11] src = 192.168.100.203 (port=1024) to dst = 172.217.173.110 (port=443) (confirmed)
 TCPv4 [          12] src = 192.168.100.203 (port=1024) to dst = 162.213.33.129 (port=443) (confirmed)
 TCPv4 [          13] src = 192.168.100.203 (port=1024) to dst = 192.168.100.153 (port=22) (confirmed)
 TCPv4 [          14] src = 192.168.100.203 (port=1024) to dst = 64.233.190.188 (port=5228) (confirmed)
 TCPv4 [          15] src = 192.168.100.203 (port=1024) to dst = 192.168.100.251 (port=8080) (confirmed)
```
  
> Note: Like said previously, all the output is sorted by protocol, source and destination addresses. This makes your life - of creating/identifying firewall rules - much easier.

## Compatibility

The **conntracker** tool has been tested in Ubuntu Linux Groovy, Focal and Bionic. 

> Note that, when running it in any Ubuntu version higher than Bionic you **might** want to change firewall code used for the connection tracking and/or tracing.

Ubuntu Groovy, for example, supports:

- xtables / netfilter
- nf_tables

And whenever you execute "iptables" command you are actually, by default, executing the nf_tables based iptables (in compatibility mode). You can change that by executing "iptables-legacy" instead. Later will make sure you use xtables instead of nftables.

The tool should work with both firewall codes, BUT if you face any issues you can visit *iptables.c* and change the binary commands used for **iptables** and **ip6tables** to **iptables-legacy** and **ip6tables-legacy** respectively (and read explanations why this being executed as a wrapper instead of using low level libs).

## TODOs

- Tests
- Improve code for a release version
- Packaging (create Ubuntu packages and a PPA)
